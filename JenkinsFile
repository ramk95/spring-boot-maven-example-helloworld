pipeline {
    agent any
    stages{
        stage('build the app'){
            steps {
                sh "docker build -t build-${BUILD_NUMBER} ."
                echo "$BRANCH_NAME"
            }
        }

        stage("Tag and Push") {
                environment { 
                    GIT_TAG = "build-$BUILD_NUMBER"
                }
                steps {
                withCredentials([usernamePassword(credentialsId: 'github_id-with-token', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
                        sh "git config user.name 'jenkins_user'"
                        sh "git config user.email 'ramakrishnan.h.1995@gmail.com'"
                        sh "git config url.git@github.com"
                        sh "git tag \$GIT_TAG"
                        sh "git push https://${GIT_USERNAME}:${GIT_PASSWORD}@<REPO> --tags"
                    }
                }
        }

        stage ('clean up dangling images'){
            steps{
                sh "docker system prune --all -f"
            }
        }
    }
}
